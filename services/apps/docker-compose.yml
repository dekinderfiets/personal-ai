services:
  # Requires redis and chroma from infra compose
  nocodb:
    image: nocodb/nocodb:latest
    container_name: nocodb_app
    ports:
      - "127.0.0.1:8080:8080"
    env_file: services/apps/.env
    environment:
      NC_TOOL_DIR: "/usr/app/data"
    volumes:
      - nocodb_data:/usr/app/data
    restart: unless-stopped
  # Requires redis and chroma from infra compose
  collector:
    build:
      context: collector
      dockerfile: Dockerfile
      target: development
    container_name: collector_service
    ports:
      - "127.0.0.1:8087:8087"
      - "127.0.0.1:5173:5173"
    env_file: collector/.env
    environment:
      REDIS_HOST: redis
      CHROMA_URL: http://chroma:8000
    volumes:
      - ./collector/src:/app/src
      - ./collector/tsconfig.json:/app/tsconfig.json
      - ./collector/nest-cli.json:/app/nest-cli.json
      - ./collector/ui/src:/app/ui/src
      - ./collector/ui/index.html:/app/ui/index.html
      - ./collector/ui/vite.config.ts:/app/ui/vite.config.ts
      - ./collector/ui/tsconfig.json:/app/ui/tsconfig.json
      - ./collector/ui/tsconfig.node.json:/app/ui/tsconfig.node.json
    restart: unless-stopped
    # Production override: uncomment below, comment out the development block above
    # build:
    #   target: production
    # command: [ "node", "dist/main" ]
    # ports: [ "127.0.0.1:8087:8087" ]
    # volumes: []

volumes:
  nocodb_data:
    name: personal-ai_nocodb_data
    external: true
networks:
  default:
    name: personal-ai-net
    external: true
